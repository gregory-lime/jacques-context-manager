# Explore: Explore handoff system

> Session: `e3024ee4-e29b-433f-8809-0238f1bda643`
> Date: 2026-02-01
> Tokens: ~59 163

---

Excellent! Now I have a comprehensive understanding. Let me provide you with a detailed report.

## Handoff System Analysis Report

### 1. How Handoffs Are Generated

The handoff system has **two generation mechanisms**:

#### A. Rule-Based Generator (Fast)
**Location**: `/core/src/handoff/generator.ts`

This is the **primary handoff generator** that works directly from transcript files:
- **Function**: `generateHandoffFromTranscript()` and `generateHandoffFromEntries()`
- **Input**: Parses JSONL transcript files using the session parser
- **Data Extracted**:
  - Session title (from summary entries or fallback to first user message)
  - Project directory
  - Files modified (from Write/Edit tool calls)
  - Tools used (extracted from tool_call entries)
  - Recent user messages (last 5, truncated to 300 chars each)
  - Message and tool call counts
  
- **Output**: Markdown document saved to `.jacques/handoffs/{timestamp}-handoff.md`
- **Token Estimate**: Uses ~4.5 chars per token approximation

#### B. LLM-Powered Generator
**Location**: `/core/src/handoff/llm-generator.ts`

Uses Claude Code CLI with the `jacques-handoff` skill:
- **Function**: `generateHandoffWithLLM()`
- **Process**: 
  1. Reads skill prompt from `~/.claude/skills/jacques-handoff/SKILL.md`
  2. Spawns Claude Code CLI subprocess
  3. Passes transcript content as user prompt
  4. Receives JSON response with detailed handoff content
  5. Saves to `.jacques/handoffs/` directory
  
- **Output Includes**: Token usage metrics (input/output tokens from Claude)
- **Supported Tools**: Read, Write, Glob, Grep

### 2. Plans in the Handoff System

**Plans are NOT currently included in the rule-based handoff generation** (`generator.ts`). The handoff markdown only contains:
- Project Context
- Current Task
- Progress Made
- Files Modified
- Tools Used
- Recent Context (last user messages)
- How to Continue section

However, **plans ARE tracked in the Archive system**:

**Archive Manifest Integration** (`/core/src/archive/manifest-extractor.ts`):
- **Function**: `detectPlans(entries)` 
- **Detection Method**: Scans for Write tool calls to plan files in:
  - `~/.claude/plans/` directory
  - Any path containing `/plans/`
  - Files with "plan" in the name ending in `.md`
- **Storage**: Stores `PlanReference[]` in the manifest with:
  - `path`: Original location (e.g., `~/.claude/plans/foo.md`)
  - `name`: Filename (e.g., `foo.md`)
  - `archivedPath`: Archive location (e.g., `plans/foo.md`)

**Archive Storage Structure**:
```
~/.jacques/archive/
├── manifests/[id].json           # ConversationManifest with plans array
├── conversations/[project]/[id].json
└── plans/[name].md               # Actual plan files copied here
```

### 3. Handoff File Structure

**Generated Markdown Format** (from `formatHandoffMarkdown()`):

```markdown
# Session Handoff

**Title:** [from summary or first message]
**Project:** [project path]
**Generated:** [ISO timestamp]
**Messages:** X | **Tool calls:** Y

## Files Modified
- path/to/file1
- path/to/file2

## Tools Used
Read, Write, Bash, etc.

## Recent Context

Last user messages from the session:
1. [message 1]
2. [message 2]
...

## How to Continue

Paste this handoff at the start of a new Claude Code session...

---
_Generated by Jacques Context Manager_
```

**File Naming Convention**:
- Format: `YYYY-MM-DDTHH-MM-SS-handoff.md`
- Example: `2026-02-01T14-35-22-handoff.md`
- Location: `.jacques/handoffs/` directory

### 4. Session-to-Handoff Connection

**Sessions and Handoffs are Loosely Connected**:

**Session Type** (`/server/src/types.ts`):
```typescript
interface Session {
  session_id: string;
  transcript_path: string | null;  // ← Key: Path to JSONL file
  session_title: string | null;
  project: string;                  // ← Project directory
  context_metrics: ContextMetrics | null;
  // ... other fields
}
```

**How They Connect**:
1. **Session has transcript_path** → Points to JSONL file in `~/.claude/projects/{path}/transcript.jsonl`
2. **Handoff generator uses transcript_path** → Reads the same JSONL file
3. **Project directory** → Used for:
   - Extracting project name/context
   - Saving handoff to `.jacques/handoffs/`
   - Detecting auto-registered sessions from context_update events

**Timeline**:
- SessionStart hook creates Session with `transcript_path`
- Later, handoff generator reads that transcript to create handoff
- Handoff saves to `[project_dir]/.jacques/handoffs/`

**Auto-Registration Feature**:
- If `context_update` event arrives before `session_start`, registry auto-creates the session
- This handles timing where statusLine fires before SessionStart hook
- Session registry is defined in `server/src/session-registry.ts`

### 5. Key Data Extraction Methods

| Data | Source | Method |
|------|--------|--------|
| Session Title | Summary entry type, or first user message | `extractTitle()` |
| Files Modified | Write/Edit tool calls | `extractFilesModified()` |
| Tools Used | tool_call entries | `extractToolsUsed()` |
| Recent Messages | Last N user messages | `extractRecentMessages()` (MAX_RECENT_MESSAGES = 5) |
| Plans | Write calls to plan paths | `detectPlans()` (archive only) |
| Technologies | Pattern matching in content | `extractTechnologies()` (archive only) |

### 6. Current Limitations

1. **Handoff generator doesn't include plans** - Only archive system detects and stores plans
2. **Handoff doesn't reference prior session context** - Uses only current transcript
3. **Limited token budget tracking** - No cost metrics in handoff (~4.5 chars/token estimate)
4. **Stateless generation** - No session object required, just transcript path

### Summary

The handoff system is a **lightweight, rule-based extraction mechanism** focused on:
- Files modified
- Tools used  
- Recent conversation context

The **archive system** handles the more sophisticated extraction including plan detection, technology detection, and manifest creation. These two systems are independent but complementary - handoffs are for fast session continuation, archives are for cross-project search and historical records.