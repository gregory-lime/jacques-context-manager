# Explore: Explore handoff generation code

> Session: `ad407d41-6bf6-491f-a1af-10f2fa41b27a`
> Date: 2026-02-01
> Tokens: ~67 114

---

Perfect! Now I have a comprehensive understanding. Let me compile my findings into a detailed report.

## Summary: Jacques Handoff Generation System

I've thoroughly explored the handoff generation system across the codebase. Here are my findings:

### 1. **Current Implementation** (`/Users/gole/Desktop/jacques-context-manager/core/src/handoff/`)

#### Generator Architecture (`generator.ts`)
The system uses **rule-based extraction** (no LLM) for fast, consistent generation:

**Key Functions:**
- `extractHandoffData()` - Parses entries and extracts structured data
- `formatHandoffMarkdown()` - Renders to markdown document
- `generateHandoffFromTranscript()` - Main entry point (reads JSONL, processes, saves)
- `generateHandoffFromEntries()` - Alternative entry (skips re-parsing if entries already loaded)

**Data Extraction Pipeline:**
```typescript
interface HandoffData {
  title: string;              // From summary entry or first user message
  projectDir: string;         // Session's working directory
  filesModified: string[];    // Write/Edit tool paths
  toolsUsed: string[];        // Unique tool names (sorted)
  recentMessages: string[];   // Last 5 user messages (max 300 chars each)
  timestamp: string;          // ISO format
  totalUserMessages: number;  // Count
  totalToolCalls: number;     // Count
}
```

#### Title Extraction (Priority Order)
1. **Summary entry** - If Claude generated `type: "summary"` entry
2. **First user message** - Fallback (truncated to 80 chars)
3. **Project name** - Last resort: `Session in {projectName}`

#### Output Format
The markdown document includes:
- **Header**: Title, project path, timestamp, message/tool counts
- **Files Modified**: List of edited files (or note if empty)
- **Tools Used**: Comma-separated sorted list
- **Recent Context**: Last N user messages (up to 5)
- **How to Continue**: Instructions for pasting in new session

Example structure (from `/Users/gole/Desktop/jacques-context-manager/.jacques/handoffs/2026-01-31T23-45-00-handoff.md`):
```markdown
# Session Handoff

> Project: Jacques Context Manager | Generated: 2026-01-31T23:45:00

## Project Context
[Project summary]

## Current Task
[What was being worked on]

## Progress Made
[Completed items with details]

## User Decisions
[Table of choices made]

## Plan Status
[Current plan file status]

## Blockers & Bugs
[Issues and resolutions]

## What Didn't Work
[Failed approaches]

## Warnings & Gotchas
[Things to know]

## Next Steps
[Actionable items]

---

_Generated by Jacques Context Manager_
```

### 2. **Dashboard Integration** (`/Users/gole/Desktop/jacques-context-manager/dashboard/src/components/`)

#### Keyboard Shortcuts (in `App.tsx`)
- **`c`** - Generate handoff from transcript (lines 837-859)
  ```typescript
  generateHandoffFromTranscript(transcriptPath, projectDir)
  ```

- **`H`** - Browse existing handoffs (lines 810-834)
  ```typescript
  listHandoffs(cwd)  // Loads and displays catalog
  ```

- **`h`** - Copy handoff prompt to clipboard (lines 799-808)
  ```typescript
  getHandoffPrompt()  // Returns invocation text
  ```

#### Handoff Browser View (`HandoffBrowserView.tsx`)
- Lists all handoffs in `.jacques/handoffs/` directory
- Shows: timestamp, token estimate, full path
- Sorted newest-first
- Navigation: Arrow keys, Enter to copy to clipboard, Esc to return

#### Compact Panel (`CompactPanel.tsx`)
- Shows when context exceeds 70% threshold
- Displays instructions for creating handoffs
- Four sections: warning message, instructions, keyboard shortcuts
- Adjusts messaging based on whether handoff file exists

### 3. **Conversation Data Format** (`/Users/gole/Desktop/jacques-context-manager/core/src/session/parser.ts`)

The parser normalizes Claude Code JSONL into:

**Entry Types Used:**
- `user_message` - User input (type: "user" or "queue-operation")
- `assistant_message` - Claude responses with text/thinking
- `tool_call` - Bash, Read, Write, Edit, etc. (extracted from assistant message's tool_use blocks)
- `summary` - Session title (auto-generated by Claude)
- `hook_progress` - Background hook events
- `turn_duration` - Timing metrics

**Data Available from Entries:**
```typescript
interface ParsedContent {
  // Messages
  text?: string;
  thinking?: string;
  
  // Tools
  toolName?: string;        // "Write", "Read", "Edit", "Bash"
  toolInput?: Record<string, unknown>;  // file_path, code, command, etc.
  
  // Metadata
  usage?: {
    inputTokens: number;
    outputTokens: number;
    cacheCreation?: number;
    cacheRead?: number;
  };
  costUSD?: number;
  durationMs?: number;
  model?: string;
}
```

### 4. **Output & Storage** (`/Users/gole/Desktop/jacques-context-manager/core/src/handoff/catalog.ts`)

**File Location:**
```
.jacques/handoffs/
└── 2026-01-31T14-30-00-handoff.md
```

**Naming Convention:**
- Format: `{ISO_TIMESTAMP_WITH_DASHES}-handoff.md`
- Example: `2026-01-31T14-30-00-handoff.md`
- Generated by: `generateHandoffFilename()` using `new Date().toISOString()`

**Token Estimation:**
```typescript
tokenEstimate = Math.ceil(content.length / 4.5)
// ~4.5 characters per token (average)
```

**Catalog Operations:**
```typescript
listHandoffs(projectDir)        // List all with metadata
getHandoffContent(path)         // Read content
getLatestHandoff(projectDir)    // Get most recent
hasHandoffs(projectDir)         // Check existence
```

### 5. **Function Signatures - Key Interfaces**

```typescript
// Main generation
async generateHandoffFromTranscript(
  transcriptPath: string,
  projectDir: string
): Promise<HandoffResult>

async generateHandoffFromEntries(
  entries: ParsedEntry[],
  projectDir: string
): Promise<HandoffResult>

// Data extraction (rule-based)
function extractHandoffData(
  entries: ParsedEntry[],
  projectDir: string
): HandoffData

// Formatting
function formatHandoffMarkdown(data: HandoffData): string

// Catalog management
interface HandoffEntry {
  filename: string;
  timestamp: Date;
  path: string;
  tokenEstimate: number;
}

interface HandoffResult {
  filePath: string;
  filename: string;
  content: string;
  tokenEstimate: number;
}
```

### 6. **Data Flow Diagram**

```
Dashboard User Input (keyboard shortcuts)
    ↓
App.tsx (handleMenuSelect / useInput)
    ├─→ [c] generateHandoffFromTranscript()
    ├─→ [H] listHandoffs() → HandoffBrowserView
    └─→ [h] getHandoffPrompt() → clipboard
    
generateHandoffFromTranscript()
    ↓
parseJSONL(transcriptPath)  [session/parser.ts]
    ↓
ParsedEntry[] array
    ↓
extractHandoffData(entries, projectDir)
    ├─→ extractTitle()
    ├─→ extractFilesModified()
    ├─→ extractToolsUsed()
    └─→ extractRecentMessages()
    ↓
formatHandoffMarkdown(data)
    ↓
fs.writeFile(handoffPath, content)
    ↓
HandoffResult { filePath, filename, content, tokenEstimate }
```

### 7. **Example Generated Handoff Structure**

The system generates two types of handoffs:

**Simple Dashboard-Generated** (from `c` shortcut):
- Files Modified (list of paths)
- Tools Used (comma-separated)
- Recent Context (last 5 messages)

**Enhanced LLM-Generated** (from `/jacques-handoff` skill):
- Project Context (orientation)
- Current Task (goal and approach)
- Progress Made (completed, in-progress, blocked)
- User Decisions (table of choices)
- Blockers & Bugs (issues and resolutions)
- What Didn't Work (anti-patterns)
- Warnings & Gotchas (things to know)
- Next Steps (actionable items)

### 8. **Key Patterns & Implementation Details**

**Token Counting:**
- Uses simple ratio: `length / 4.5` (based on empirical testing)
- Displayed as formatted strings: "2.1k", "500", etc.

**Error Handling:**
- Transcript not found → Shows notification
- Parse errors → Skips invalid JSON lines
- Missing files → Graceful fallbacks

**Conversions & Formatting:**
```typescript
formatHandoffDate(date: Date): string
  // "01/31/26, 14:30" format

parseTimestampFromFilename(filename: string): Date
  // Extracts from "2026-01-31T14-30-00-handoff.md"

formatTokenEstimate(tokens: number): string
  // "2.1k" or "500"
```

### 9. **Context Manager Integration**

The handoff system is exported from `@jacques/core` package:

```typescript
// From core/src/index.ts
export {
  listHandoffs,
  getHandoffContent,
  generateHandoffFromTranscript,
  generateHandoffFromEntries,
  getHandoffPrompt,
  formatHandoffMarkdown,
  extractHandoffData,
} from "./handoff/index.js"

export type {
  HandoffEntry,
  HandoffCatalog,
  HandoffData,
  HandoffResult,
}
```

This allows the dashboard to import and use these functions consistently with other core modules (archive, context, sources).