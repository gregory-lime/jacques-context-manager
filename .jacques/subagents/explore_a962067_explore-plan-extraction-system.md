# Explore: Explore plan extraction system

> Session: `b1a7eed5-9a35-4ace-a47b-6865d6338fc8`
> Date: 2026-02-02
> Tokens: ~70 074

---

Perfect! Now I have a comprehensive understanding. Let me create a summary document of my findings:

## Summary: Plan Extraction System in Jacques Context Manager

Based on my thorough exploration of the codebase, here's a comprehensive understanding of how the plan extraction system works:

### 1. Plan Detection and Extraction

**Location**: `/Users/gole/Desktop/jacques-context-manager/core/src/archive/plan-extractor.ts`

The system detects inline plans through three trigger patterns:
```typescript
const PLAN_TRIGGER_PATTERNS = [
  /^implement the following plan[:\s]*/i,
  /^here is the plan[:\s]*/i,
  /^follow this plan[:\s]*/i,
];
```

**Key validation rules**:
- Minimum content length: 100 characters (measured AFTER removing the trigger phrase)
- Must contain at least one markdown heading (`#`)
- Only processes user messages, ignores assistant messages
- Case-insensitive pattern matching

**Core function: `detectEmbeddedPlans(entries)`**
- Scans all `ParsedEntry[]` array for user messages
- Returns array of `DetectedPlan` objects with metadata:
  - `planContent`: The extracted markdown content
  - `messageIndex`: Position in entries array
  - `planIndex`: Index if multiple plans split by heading
  - `triggeredBy`: The exact trigger phrase matched

### 2. Multiple Plans in Single Message

**Function: `splitMultiplePlans(content)`**

Plans are split by top-level markdown headings (`^#\s+`):
- Finds first heading in content, then treats each new top-level heading as a new plan
- If no headings found, treats entire content as single plan
- Each plan is independently extracted and processed

**Example from test**:
```
# Plan A

Content for plan A...

# Plan B

Content for plan B...
```
Returns two separate plan strings

### 3. Duplicate Detection (Jaccard Similarity)

**Function: `findDuplicatePlan(content, projectPath)`**

Three-tier duplicate detection strategy:

1. **Exact Hash Match** (SHA-256):
   - Normalized content: `content.replace(/\s+/g, " ").toLowerCase().trim()`
   - If hashes match exactly → plan is a duplicate

2. **Fuzzy Match** (Jaccard Similarity):
   - Title must normalize to same string (lowercase, alphanumeric only)
   - Length range must match (buckets: 0-500, 501-2000, 2001+)
   - Jaccard similarity threshold: **0.9** (90% word overlap)
   - Calculates: `intersection.size / union.size` for words >3 chars

3. **Comparison**: `calculateSimilarity(text1, text2)`
   - Extracts words >3 characters from both texts
   - Uses Set operations to compute Jaccard similarity
   - Used during extraction to detect duplicates within same session

### 4. Plan Storage and Indexing

**Location**: `.jacques/index.json` and `.jacques/plans/` directory

**PlanEntry schema** (from `core/src/context/types.ts`):
```typescript
interface PlanEntry {
  id: string;                    // Filename without .md (e.g., "2026-02-01_auth-system")
  title: string;                 // Extracted from first # heading
  filename: string;              // e.g., "2026-02-01_auth-system.md"
  path: string;                  // Relative path: "plans/2026-02-01_auth-system.md"
  createdAt: string;             // ISO timestamp
  updatedAt: string;             // ISO timestamp
  sessions: string[];            // Array of session IDs that use this plan
}
```

**Filename format**:
- Generated by `generatePlanFilename(title)` → `YYYY-MM-DD_title-slug.md`
- Date from current date, title normalized (lowercase, alphanumeric+dash only)
- Limited to 50 chars for the slug portion

**Versioning**: If filename collision detected, appends version: `YYYY-MM-DD_title-slug-v2.md`

**Index location**: `projectPath/.jacques/index.json`

### 5. Extraction Triggers

**When embedded plans are extracted**:

1. **Save Context** (Manual):
   - Dashboard menu option `[1] Save Context`
   - Calls `saveContext()` or `saveToArchive()`
   - Extracts from parsed entries

2. **Archive Conversation** (Automatic or Manual):
   - Called via `archiveConversation()` after manifest creation
   - Manifest extraction calls `extractEmbeddedPlans(entries, projectPath, sessionId)`
   - Archives plans to global `~/.jacques/archive/plans/`

3. **Session Handoff** (Manual):
   - `/jacques-handoff` skill
   - Calls plan-extractor for context creation

**Implementation flow**:
```
saveContext() 
  → extractManifestFromEntries(entries)
    → detectPlans(entries)  [finds Write tool plans]
    → [SEPARATE] extractEmbeddedPlans(entries)  [finds inline plans]
  → archiveConversation(manifest)
    → archives both write-based and embedded plans
```

### 6. PlanReference Type (Used in Manifests)

**Location**: `core/src/archive/types.ts`

```typescript
interface PlanReference {
  path: string;              // Absolute path to plan file
  name: string;              // Filename only (e.g., "2026-02-01_auth-system.md")
  archivedPath: string;      // Relative archive path: "plans/filename"
  source: "embedded" | "write";  // Detection method
}
```

**Two detection sources in manifest extraction**:

1. **Write tool plans** (via `detectPlans()` in manifest-extractor.ts):
   - Finds `Write` tool calls with paths in `~/.claude/plans/` or containing `/plans/`
   - Source: `"write"`

2. **Embedded plans** (via `extractEmbeddedPlans()` in plan-extractor.ts):
   - Finds plans in user messages with trigger phrases
   - Source: `"embedded"`

### 7. Bidirectional Session Linking

**In `.jacques/index.json`**, each `PlanEntry` maintains array of `sessions` UUIDs:
- When a plan is indexed, its session ID is added
- When same plan appears in another session, session ID is appended
- Deduplication prevents duplicate session references

**From actual index**:
```json
{
  "id": "2026-02-01_archive-display-filtering-improvements",
  "title": "Archive Display & Filtering Improvements",
  "filename": "2026-02-01_archive-display-filtering-improvements.md",
  "path": "plans/2026-02-01_archive-display-filtering-improvements.md",
  "sessions": ["21ea55e2-80bc-4adb-bf99-47e013418abf"]
}
```

### 8. Current Limitations/Gotchas

1. **Minimum content validation**: Must be ≥100 characters AFTER trigger phrase removed (not including trigger)
2. **Jaccard similarity**: 0.9 threshold is quite high - minor wording differences may not match
3. **Path encoding in index**: One entry shows absolute path instead of relative (`/Users/gole/...` instead of `plans/...`) - appears to be a bug
4. **Write-based plans not auto-extracted**: Plans created via Write tool aren't tracked in index separately, only in manifest
5. **Embedded plans only in user messages**: Plans in assistant messages ignored by `detectEmbeddedPlans()`

### 9. Test Coverage

**Location**: `/Users/gole/Desktop/jacques-context-manager/core/src/archive/plan-extractor.test.ts`

Comprehensive test suite (37/37 tests passing):
- Detection (7 tests): trigger patterns, multiple plans, validation
- Splitting (5 tests): multiple headings, fallback handling
- Title extraction (5 tests): markdown headings, truncation
- Deduplication (6 tests): hashing, similarity, edge cases
- Indexing (3 tests): creation, merging, deduplication
- Full extraction flow (5 tests): single/multiple plans, duplicates, errors
- Duplicate detection (4 tests): exact/fuzzy matching, no matches

### 10. File Paths and Locations

| Component | Path |
|-----------|------|
| Extractor module | `core/src/archive/plan-extractor.ts` |
| Types | `core/src/archive/types.ts` (PlanReference) and `core/src/context/types.ts` (PlanEntry) |
| Indexer | `core/src/context/indexer.ts` |
| Manifest extraction | `core/src/archive/manifest-extractor.ts` |
| Storage/archiving | `core/src/storage/writer.ts` and `core/src/archive/archive-store.ts` |
| Tests | `core/src/archive/plan-extractor.test.ts` |
| Example index | `.jacques/index.json` in project |
| Saved plans | `.jacques/plans/` directory |
| Archived plans | `~/.jacques/archive/plans/` directory |